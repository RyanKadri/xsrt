version: '3.7'
services:
    mongo:
        image: mongo:4.0
        volumes:
            - mongo-data:/data/db
        expose:
            - 27017
        ports:
            - 27017:27017
    app:
        expose:
            - ${API_PORT}
        ports:
            - ${API_PORT}:${API_PORT}
            - 9229:9229
        links:
            - mongo
            - decorator
        depends_on:
            - mongo
        restart: unless-stopped
        environment:
            - MONGO_URL=mongodb://mongo/recordings
            - DECORATOR_URL=http://decorator:${DECORATOR_PORT}
            - API_PORT=${API_PORT}
            - STORAGE_LOCATION=${STORAGE_LOCATION}
        volumes:
            - '.:/app/'
        build:
            context: .
            target: dev-api
            args:
                port: "${API_PORT}"
            dockerfile: dev.Dockerfile
        command: npx nodemon --delay 1000ms --inspect=0.0.0.0:9229 -w ./dist/backend ./dist/backend/api-server.bundle.js
    decorator:
        expose:
            - ${DECORATOR_PORT}
        ports:
            - ${DECORATOR_PORT}:${DECORATOR_PORT}
            - 9230:9230
        links:
            - mongo
        depends_on:
            - mongo
        restart: unless-stopped
        environment:
            - MONGO_URL=mongodb://mongo/recordings
            - DECORATOR_PORT=${DECORATOR_PORT}
        volumes:
            - '.:/app/'
        build:
            context: .
            target: dev-decorator
            args:
                port: "${DECORATOR_PORT}"
            dockerfile: dev.Dockerfile
        command: npx nodemon --delay 1000ms --inspect=0.0.0.0:9230 -w ./dist/backend ./dist/backend/decorator-server.bundle.js
    builder:
        volumes:
            - '.:/app'
        expose:
            - ${WEBPACK_PORT}
        ports:
            - ${WEBPACK_PORT}:${WEBPACK_PORT}
        environment:
            - WEBPACK_PORT=${WEBPACK_PORT}
            - STATIC_ASSET_SERVER=http://static:${STATIC_PORT}/
            - API_SERVER=http://app:${API_PORT}/
        build:
            context: .
            target: dev-builder
            dockerfile: dev.Dockerfile
volumes:
    mongo-data:
    stored-files:
