version: "3.7"
services:
  mongo:
    image: mongo:4.0
    volumes:
      - mongo-data:/data/db
    expose:
      - 27017
    ports:
      - 27017:27017
  app:
    expose:
      - ${API_PORT}
    links:
      - mongo
      - decorator
    volumes:
      - stored-files:${STORAGE_LOCATION}
    depends_on:
      - mongo
      - decorator
    environment:
      - MONGO_URL=mongodb://mongo/recordings
      - DECORATOR_URL=http://decorator:${DECORATOR_PORT}
      - API_PORT=${API_PORT}
      - STORAGE_LOCATION=${STORAGE_LOCATION}
    build:
      context: .
      target: api
      args:
        port: "${API_PORT}"
  decorator:
    expose:
      - ${DECORATOR_PORT}
    links:
      - mongo
    volumes:
      - stored-files:${STORAGE_LOCATION}
    depends_on:
      - mongo
    environment:
      - MONGO_URL=mongodb://mongo/recordings
      - DECORATOR_PORT=${DECORATOR_PORT}
      - API_SERVER=http://app:${API_PORT}
    build:
      context: .
      target: decorator
      args:
        port: "${DECORATOR_PORT}"
  static:
    ports:
      - ${STATIC_PORT}:80
    volumes:
      - ${STORAGE_LOCATION}:/app
    environment:
      - FRONTEND_HOSTNAME=${FRONTEND_HOSTNAME}
      - APP_ROOT=/app
    build:
      context: .
      dockerfile: ./conf/docker/nginx.Dockerfile
      target: static-frontend
    command: /bin/sh -c "envsubst '$${STORAGE_LOCATION},$${FRONTEND_HOSTNAME},$${API_SERVER},$${APP_ROOT}' < /etc/nginx/nginx.conf.template > /etc/nginx/nginx.conf && exec nginx -g 'daemon off;'"
  rabbit:
    image: rabbitmq:3.7.12-management
    hostname: rabbit
    expose:
      - 5672
    ports:
      - 5672:5672
      - 15672:15672
    volumes:
      - rabbit-data:/var/lib/rabbitmq
  elastic:
    image: elasticsearch:7.8.0
    ports:
      - "9200:9200"
      - "9300:9300"
    volumes:
      - elastic-data:/usr/share/elasticsearch/data
    environment:
      - discovery.type=single-node
  kibana:
    image: kibana:7.8.0
    ports:
      - 5601:5601
    environment:
      - ELASTICSEARCH_HOSTS=http://elastic:9200
volumes:
  mongo-data:
  stored-files:
  rabbit-data:
  elastic-data:
